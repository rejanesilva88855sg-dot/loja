<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí Seu Carrinho | Kiwify Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style id="dynamicStyles">
        /* VARI√ÅVEIS DE CORES DIN√ÇMICAS (Ser√£o preenchidas pelo JS) */
        :root {
            --primary-color: #5B48CC; 
            --secondary-color: #28a745; 
            --danger-color: #FF3B30; 
            --background-light: #f4f5f9; /* Fundo da loja Light */
            --card-bg: #ffffff; 
            --border-color: #e0e0e0; 
            --text-dark: #333; 
            --text-medium: #666; 
        }

        /* Base e Layout - AGORA √â LIGHT */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light); /* CORRIGIDO: Fundo Light */
            color: var(--text-dark); /* CORRIGIDO: Texto escuro no fundo claro */
            padding: 0;
            margin: 0;
        }
        .main-container {
            max-width: 900px; 
            margin: 40px auto;
            padding: 0 20px;
        }
        h1 {
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* Lista de Itens do Carrinho */
        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        .item-details {
            flex: 3;
        }
        .item-details h4 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-dark);
        }
        .item-details p {
            margin: 5px 0 0 0;
            font-size: 0.9em;
            color: var(--text-medium);
        }
        .item-quantity {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
        }
        .item-quantity button {
            padding: 5px; 
            background-color: var(--card-bg); 
            color: var(--text-dark); /* CORRIGIDO */
            border: 1px solid var(--border-color); 
            cursor: pointer;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
        }
        .item-quantity input {
            width: 50px;
            padding: 8px;
            text-align: center;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            background-color: var(--background-light); /* Fundo do input mais claro */
            color: var(--text-dark);
            margin: 0 5px;
        }
        .item-price {
            flex: 1;
            font-size: 1.2em;
            font-weight: 800;
            color: var(--secondary-color); /* CORRIGIDO */
            text-align: right;
        }
        .item-remove button {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 1.5em;
            cursor: pointer;
            padding-left: 15px;
        }
        
        /* Resumo do Carrinho */
        .cart-summary {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
            border: 1px solid var(--border-color);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--text-dark);
        }
        .total-row {
            border-top: 2px solid var(--border-color);
            padding-top: 15px;
            margin-top: 15px;
        }
        .total-row .label {
            font-weight: 700;
            font-size: 1.3em;
            color: var(--text-dark);
        }
        .total-row .value {
            font-weight: 800;
            font-size: 1.8em;
            color: var(--primary-color); /* CORRIGIDO */
        }

        /* Bot√£o Checkout */
        #checkoutButton {
            display: block;
            width: 100%;
            padding: 18px;
            margin-top: 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        #checkoutButton:hover { opacity: 0.9; }
        #checkoutButton:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        /* Carrinho Vazio */
        .empty-cart {
            text-align: center;
            padding: 50px 20px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            color: var(--text-medium);
        }
        .empty-cart a {
             color: var(--primary-color);
             text-decoration: none;
             font-weight: 600;
        }
        .empty-cart p { margin-bottom: 15px; }
        
        @media (max-width: 600px) {
            .cart-item {
                flex-wrap: wrap;
            }
            .item-details, .item-quantity, .item-price, .item-remove {
                flex-basis: 100%;
                text-align: left;
                margin-bottom: 10px;
            }
            .item-quantity {
                justify-content: flex-start;
            }
            .item-price {
                text-align: left;
                font-size: 1.5em;
            }
            .item-remove {
                padding-left: 0;
                text-align: right;
            }
        }
    </style>
</head>
<body>

<div class="main-container">
    <a href="index.html" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">&leftarrow; Continuar Comprando</a>
    
    <h1>üõí Meu Carrinho de Compras</h1>

    <div id="cartItemsContainer">
        </div>
    
    <div id="cartSummaryContainer" style="display:none;">
        <div class="cart-summary">
            <div class="summary-row">
                <span>Subtotal:</span>
                <span id="subtotalValue">R$ 0,00</span>
            </div>
            <div class="summary-row">
                <span>Frete (Mock):</span>
                <span id="shippingValue">R$ 0,00</span>
            </div>
            <div class="summary-row total-row">
                <span class="label">TOTAL A PAGAR:</span>
                <span class="value" id="totalValue">R$ 0,00</span>
            </div>
        </div>
        
        <button id="checkoutButton">FINALIZAR COMPRA</button>
    </div>

    <div id="emptyCartMessage" class="empty-cart" style="display:none;">
        <h3>Seu Carrinho est√° Vazio!</h3>
        <p>Parece que voc√™ ainda n√£o adicionou nenhum item.</p>
        <p><a href="index.html">Volte para a p√°gina inicial e descubra nossos produtos.</a></p>
    </div>
</div>

<script>
    // Constantes (Para carregar as vari√°veis de cor din√¢micas)
    const STORE_SETTINGS_FILE = '/store_settings.json'; 

    // --- UTILS ---
    function getCartItems() {
        try {
            return JSON.parse(localStorage.getItem('cartItems')) || [];
        } catch (e) {
            console.error("Erro ao ler cartItems:", e);
            return [];
        }
    }
    
    function saveCartItems(items) {
        localStorage.setItem('cartItems', JSON.stringify(items));
    }
    
    function valueToNumber(valueString) {
        if (!valueString) return 0;
        // Limpa R$, remove ponto de milhar e troca v√≠rgula por ponto decimal
        return parseFloat(valueString.replace(/R\$/g, '').replace(/\./g, '').replace(',', '.').trim());
    }

    function numberToValue(number) {
        if (isNaN(number)) return 'R$ 0,00';
        return 'R$ ' + number.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function applyStoreStyles(settings) {
        const root = document.documentElement.style;
        // Aplica cores prim√°rias, secund√°rias e background do card
        root.setProperty('--primary-color', settings.primaryColor || '#5B48CC');
        root.setProperty('--secondary-color', settings.secondaryColor || '#28a745');
        root.setProperty('--card-bg', settings.cardBgColor || '#ffffff');
        // Usa as cores da loja para o background e texto
        root.setProperty('--background-light', settings.backgroundLight || '#f4f5f9');
        root.setProperty('--text-dark', settings.textDark || '#333');
    }
    
    // --- L√ìGICA DO CARRINHO ---

    function renderCart() {
        const cartItems = getCartItems();
        const container = document.getElementById('cartItemsContainer');
        const summary = document.getElementById('cartSummaryContainer');
        const emptyMessage = document.getElementById('emptyCartMessage');
        const checkoutButton = document.getElementById('checkoutButton');
        let total = 0;

        if (cartItems.length === 0) {
            container.innerHTML = '';
            summary.style.display = 'none';
            emptyMessage.style.display = 'block';
            if(checkoutButton) checkoutButton.disabled = true;
            return;
        }

        emptyMessage.style.display = 'none';
        summary.style.display = 'block';
        if(checkoutButton) checkoutButton.disabled = false;

        let html = '';
        cartItems.forEach(item => {
            const price = valueToNumber(item.value);
            const subtotalItem = price * item.quantity;
            total += subtotalItem;

            html += `
                <div class="cart-item" data-key="${item.key}">
                    <div class="item-details">
                        <h4>${item.title}</h4>
                        <p>Valor Unit√°rio: ${numberToValue(price)}</p>
                    </div>
                    <div class="item-quantity">
                        <button onclick="updateQuantity('${item.key}', -1)">-</button>
                        <input type="number" value="${item.quantity}" min="1" 
                               onchange="updateQuantityInput('${item.key}', this.value)"
                               onkeydown="return event.key !== 'e'">
                        <button onclick="updateQuantity('${item.key}', 1)">+</button>
                    </div>
                    <div class="item-price">
                        ${numberToValue(subtotalItem)}
                    </div>
                    <div class="item-remove">
                        <button onclick="removeItem('${item.key}')" title="Remover item">&times;</button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        updateSummary(total);
    }
    
    function updateQuantity(key, change) {
        let cartItems = getCartItems();
        const item = cartItems.find(i => i.key === key);

        if (item) {
            item.quantity += change;
            if (item.quantity < 1) {
                removeItem(key); // Remove se a quantidade for zero ou menor
                return;
            }
            saveCartItems(cartItems);
            renderCart(); // Renderiza novamente para atualizar a UI e o total
        }
    }
    
    function updateQuantityInput(key, newQuantity) {
        let cartItems = getCartItems();
        const item = cartItems.find(i => i.key === key);
        const quantity = parseInt(newQuantity);

        if (item && !isNaN(quantity)) {
             if (quantity < 1) {
                 removeItem(key);
                 return;
             }
             item.quantity = quantity;
             saveCartItems(cartItems);
             renderCart();
        } else {
             // Reverte para a quantidade atual se a entrada for inv√°lida
             renderCart(); 
        }
    }

    function removeItem(key) {
        let cartItems = getCartItems();
        const newCartItems = cartItems.filter(item => item.key !== key);
        saveCartItems(newCartItems);
        renderCart();
    }
    
    function updateSummary(subtotal) {
        const shipping = 0; // Frete Gr√°tis (Mock)
        const total = subtotal + shipping;
        
        document.getElementById('subtotalValue').textContent = numberToValue(subtotal);
        document.getElementById('shippingValue').textContent = numberToValue(shipping);
        document.getElementById('totalValue').textContent = numberToValue(total);
    }

    // --- L√ìGICA DE CHECKOUT ---
    function redirectToCheckout() {
        const cartItems = getCartItems();
        if (cartItems.length === 0) {
            alert('Seu carrinho est√° vazio. Adicione produtos antes de prosseguir.');
            return;
        }

        // 1. Criar um objeto compacto para passar via URL/Query String
        // Formato: key1,qty1|key2,qty2|key3,qty3
        const cartString = cartItems.map(item => `${item.key},${item.quantity}`).join('|');
        
        // 2. Redirecionar para o checkout com a string do carrinho
        window.location.href = `checkout_form.php?cart=${encodeURIComponent(cartString)}`;
    }

    // --- Inicializa√ß√£o ---
    async function initializeCartLogic() {
         try {
            const settingsResponse = await fetch(`${STORE_SETTINGS_FILE}?t=${Date.now()}`); 
            const storeSettings = await settingsResponse.json();
            applyStoreStyles(storeSettings);
         } catch (e) {
             console.warn("Falha ao carregar configura√ß√µes da loja para o tema do carrinho.");
         }

        renderCart();
        
        const checkoutButton = document.getElementById('checkoutButton');
        if(checkoutButton) {
            checkoutButton.addEventListener('click', redirectToCheckout);
        }
        
        // Exp√µe fun√ß√µes globais para o HTML
        window.updateQuantity = updateQuantity;
        window.updateQuantityInput = updateQuantityInput;
        window.removeItem = removeItem;
    }

    document.addEventListener('DOMContentLoaded', initializeCartLogic);
</script>
</body>
</html>